<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Watch Together Platform</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
  <style>
    /* Themes */
    :root {
      --color-bg: #001f3f; /* Navy Blue (NetMirror-like) */
      --color-text: #fff;
      --color-primary: #007bff;
      --color-primary-hover: #0056b3;
      --color-btn-bg: var(--color-primary);
      --color-btn-hover-bg: var(--color-primary-hover);
      --color-input-bg: #003366;
      --color-input-text: #fff;
      --color-border: #005080;
    }
    body.blue-theme {
      --color-bg: #001f3f;
      --color-primary: #007bff;
      --color-primary-hover: #0056b3;
      --color-btn-bg: var(--color-primary);
      --color-btn-hover-bg: var(--color-primary-hover);
      --color-input-bg: #003366;
      --color-border: #005080;
    }
    body.red-theme {
      --color-bg: #4d0000;
      --color-primary: #ff4d4d;
      --color-primary-hover: #cc0000;
      --color-btn-bg: var(--color-primary);
      --color-btn-hover-bg: var(--color-primary-hover);
      --color-input-bg: #660000;
      --color-border: #990000;
    }
    body.black-theme {
      --color-bg: #000;
      --color-primary: #444;
      --color-primary-hover: #222;
      --color-btn-bg: var(--color-primary);
      --color-btn-hover-bg: var(--color-primary-hover);
      --color-input-bg: #222;
      --color-border: #444;
    }

    body {
      background-color: var(--color-bg);
      color: var(--color-text);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 900px;
      margin-top: 20px;
      padding: 10px;
    }

    input.form-control, select.form-control {
      background-color: var(--color-input-bg);
      color: var(--color-input-text);
      border: 1px solid var(--color-border);
    }

    input.form-control::placeholder {
      color: #ccc;
    }

    button.btn-primary, button.btn-success, button.btn-warning, button.btn-danger, button.btn-secondary, button.btn-outline-light {
      background-color: var(--color-btn-bg);
      border-color: var(--color-btn-bg);
      color: var(--color-text);
      transition: background-color 0.3s ease;
    }
    button.btn-primary:hover, button.btn-success:hover, button.btn-warning:hover, button.btn-danger:hover, button.btn-secondary:hover, button.btn-outline-light:hover {
      background-color: var(--color-btn-hover-bg);
      border-color: var(--color-btn-hover-bg);
      color: var(--color-text);
    }

    video {
      width: 100%;
      max-width: 800px;
      border-radius: 10px;
      background: black;
    }

    #main, #settingsPage, #dashboardPage {
      display: none;
    }

    .user-dropdown {
      position: absolute;
      top: 10px;
      right: 20px;
      text-align: right;
      z-index: 100;
    }

    .user-dropdown-menu {
      background-color: #222;
      border-radius: 5px;
      padding: 10px;
      display: none;
      width: 150px;
    }

    /* Loader */
    #loaderOverlay {
      position: fixed;
      top:0; left:0; right:0; bottom:0;
      background: rgba(0,0,0,0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      display: none;
    }

    .loader {
      border: 8px solid #f3f3f3;
      border-top: 8px solid var(--color-primary);
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1.5s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }

    /* Responsive */
    @media (max-width: 768px) {
      video {
        max-width: 100%;
        height: auto;
      }
      #videoUrl {
        width: 100% !important;
      }
      .user-dropdown {
        right: 10px;
        top: 5px;
      }
    }

    /* Tabs for themes */
    .theme-selector {
      margin-bottom: 20px;
      text-align: center;
    }
    .theme-selector button {
      margin: 0 5px;
      min-width: 60px;
    }

    /* Settings Form */
    #settingsPage input.form-control {
      margin-bottom: 10px;
    }

    /* Dashboard user list */
    #dashboardUserList {
      max-height: 300px;
      overflow-y: auto;
      background-color: var(--color-input-bg);
      padding: 10px;
      border-radius: 5px;
      border: 1px solid var(--color-border);
    }

  </style>
</head>
<body class="blue-theme">

<!-- Loader -->
<div id="loaderOverlay"><div class="loader"></div></div>

<!-- Auth Container -->
<div class="container" id="authContainer">
  <div id="authBox" class="text-center"></div>
</div>

<!-- Main App -->
<div class="container" id="main">
  <div class="user-dropdown">
    <div>
      <strong id="userInfo"></strong>
      <button class="btn btn-sm btn-light" onclick="toggleDropdown()">üë§</button>
    </div>
    <div id="userMenu" class="user-dropdown-menu">
      <div id="status">Status: Online</div>
      <button class="btn btn-sm btn-secondary w-100 mt-2" onclick="showSettings()">Settings</button>
      <button id="dashboardBtn" class="btn btn-sm btn-info w-100 mt-2" style="display:none;" onclick="showDashboard()">Dashboard</button>
      <button class="btn btn-sm btn-danger w-100 mt-2" onclick="logout()">Logout</button>
    </div>
  </div>

  <h2 class="text-center my-4">üé¨ Watch Together</h2>

  <div class="theme-selector">
    <span>Theme:</span>
    <button class="btn btn-sm btn-primary" onclick="changeTheme('blue')">Blue</button>
    <button class="btn btn-sm btn-danger" onclick="changeTheme('red')">Red</button>
    <button class="btn btn-sm btn-dark" onclick="changeTheme('black')">Black</button>
  </div>

  <div class="text-center mb-3">
    <input type="text" class="form-control w-75 d-inline-block" id="videoUrl" placeholder="Paste video link..." />
    <button class="btn btn-primary" onclick="loadVideo()">Load</button>
  </div>

  <div id="videoContainer" class="text-center">
    <video id="videoPlayer" controls></video>
    <div class="mt-2">
      <button class="btn btn-outline-light" onclick="seek(-10)">‚è™ 10s</button>
      <button class="btn btn-outline-light" onclick="seek(10)">‚è© 10s</button>
      <button class="btn btn-outline-light" onclick="toggleFullScreen()">üî≥ Fullscreen</button>
    </div>
  </div>

  <hr class="bg-light" />

  <h3 class="text-center">üé• Video Call + Screen Share</h3>
  <div class="text-center">
    <video id="localVideo" autoplay muted playsinline style="width: 45%; max-width: 300px; margin: 5px;"></video>
    <video id="remoteVideo" autoplay playsinline style="width: 45%; max-width: 300px; margin: 5px;"></video><br />
    <button class="btn btn-success mt-2" onclick="startVideoCall()">Start Video Call</button>
    <button class="btn btn-warning mt-2" onclick="toggleScreenShare()">Share Screen</button>
  </div>
</div>

<!-- Settings Page -->
<div class="container" id="settingsPage">
  <h2 class="text-center mb-4">‚öôÔ∏è Settings</h2>
  <form id="changePassForm" class="mx-auto" style="max-width:400px;">
    <input type="password" id="currentPassword" class="form-control" placeholder="Current Password" required />
    <input type="password" id="newPassword" class="form-control" placeholder="New Password" required />
    <input type="password" id="confirmPassword" class="form-control" placeholder="Confirm New Password" required />
    <button type="submit" class="btn btn-success w-100">Change Password</button>
    <button type="button" class="btn btn-secondary w-100 mt-2" onclick="closeSettings()">Back</button>
  </form>
</div>

<!-- Dashboard Page -->
<div class="container" id="dashboardPage">
  <h2 class="text-center mb-4">üìã Dashboard - User List</h2>
  <div id="dashboardUserList"></div>
  <button class="btn btn-secondary mt-3" onclick="closeDashboard()">Close Dashboard</button>
</div>

<script>
  // Elements
  const authContainer = document.getElementById('authContainer');
  const main = document.getElementById('main');
  const userInfo = document.getElementById('userInfo');
  const dashboardBtn = document.getElementById('dashboardBtn');
  const settingsPage = document.getElementById('settingsPage');
  const dashboardPage = document.getElementById('dashboardPage');
  const loaderOverlay = document.getElementById('loaderOverlay');
  const dashboardUserList = document.getElementById('dashboardUserList');

  // Session + Auth Logic
  let users = JSON.parse(sessionStorage.getItem('users')) || [];
  let currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
  let currentTheme = localStorage.getItem('theme') || 'blue';

  // Apply saved theme
  document.body.classList.remove('blue-theme','red-theme','black-theme');
  document.body.classList.add(currentTheme + '-theme');

  function animateAuthBox() {
    gsap.from("#authBox", { duration: 0.5, y: -50, opacity: 0 });
  }

  // Auth Forms
  function showLoginForm() {
    authContainer.style.display = 'block';
    main.style.display = 'none';
    settingsPage.style.display = 'none';
    dashboardPage.style.display = 'none';
    document.getElementById('authBox').innerHTML = `
      <h3>Login</h3>
      <input id="loginEmail" class="form-control" placeholder="Email" />
      <input id="loginPass" type="password" class="form-control" placeholder="Password" />
      <button class="btn btn-primary w-100" onclick="login()">Login</button>
      <p class="mt-2 text-white">No account? <a href="#" onclick="showRegisterForm()">Register</a></p>
    `;
    animateAuthBox();
  }

  function showRegisterForm() {
    authContainer.style.display = 'block';
    main.style.display = 'none';
    settingsPage.style.display = 'none';
    dashboardPage.style.display = 'none';
    document.getElementById('authBox').innerHTML = `
      <h3>Register</h3>
      <input id="fname" class="form-control" placeholder="First Name" />
      <input id="lname" class="form-control" placeholder="Last Name" />
      <input id="email" class="form-control" placeholder="Email" />
      <input id="pass" type="password" class="form-control" placeholder="Password" />
      <button class="btn btn-success w-100" onclick="register()">Register</button>
      <p class="mt-2 text-white">Already have account? <a href="#" onclick="showLoginForm()">Login</a></p>
    `;
    animateAuthBox();
  }

  // Prevent duplicate emails during registration
  function register() {
    const fname = document.getElementById('fname').value.trim();
    const lname = document.getElementById('lname').value.trim();
    const email = document.getElementById('email').value.trim().toLowerCase();
    const pass = document.getElementById('pass').value;

    if(!fname || !lname || !email || !pass) {
      alert('Please fill all fields.');
      return;
    }

    if(users.some(u => u.email === email)) {
      alert('Email already registered!');
      return;
    }

    const user = { fname, lname, email, pass };
    users.push(user);
    sessionStorage.setItem('users', JSON.stringify(users));
    alert('Registered Successfully! Please login.');
    showLoginForm();
  }

  // Login
  function login() {
    const email = document.getElementById('loginEmail').value.trim().toLowerCase();
    const pass = document.getElementById('loginPass').value;
    currentUser = users.find(u => u.email === email && u.pass === pass);
    if (currentUser) {
      sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
      alert('Login successful');
      authContainer.style.display = 'none';
      main.style.display = 'block';
      settingsPage.style.display = 'none';
      dashboardPage.style.display = 'none';
      userInfo.innerText = `${currentUser.fname} ${currentUser.lname}`;
      dashboardBtn.style.display = currentUser.email === 'admin@gmail.com' ? 'block' : 'none';
    } else {
      alert('Invalid credentials');
    }
  }

  // Logout
  function logout() {
    sessionStorage.removeItem('currentUser');
    location.reload();
  }

  // Toggle user dropdown
  function toggleDropdown() {
    const dropdown = document.getElementById("userMenu");
    dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
  }

  // Theme change
  function changeTheme(theme) {
    document.body.classList.remove('blue-theme','red-theme','black-theme');
    document.body.classList.add(theme + '-theme');
    currentTheme = theme;
    localStorage.setItem('theme', theme);
  }

  // Video Player Functions
  const videoPlayer = document.getElementById('videoPlayer');
  function loadVideo() {
    const url = document.getElementById('videoUrl').value.trim();
    if (url) {
      videoPlayer.src = url;
      videoPlayer.load();
    }
  }
  function seek(seconds) {
    videoPlayer.currentTime += seconds;
  }
  function toggleFullScreen() {
    if (!document.fullscreenElement) videoPlayer.requestFullscreen();
    else document.exitFullscreen();
  }

  // WebRTC for Video Call & Screen Share
  let localStream, remoteStream, peerConnection, screenStream;
  const servers = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

  async function startVideoCall() {
    try {
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      document.getElementById('localVideo').srcObject = localStream;

      peerConnection = new RTCPeerConnection(servers);
      peerConnection.ontrack = e => {
        document.getElementById('remoteVideo').srcObject = e.streams[0];
      };
      localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

      if (location.hash === "#host") {
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        console.log("Offer to guest:\n", JSON.stringify(offer));
      } else {
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
        console.log("Answer to host:\n", JSON.stringify(answer));
      }
    } catch(err) {
      alert("Error starting video call: " + err.message);
    }
  }

  async function toggleScreenShare() {
    if (!screenStream) {
      try {
        screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
        const screenTrack = screenStream.getTracks()[0];
        const sender = peerConnection.getSenders().find(s => s.track.kind === "video");
        sender.replaceTrack(screenTrack);
        screenTrack.onended = () => {
          sender.replaceTrack(localStream.getVideoTracks()[0]);
          screenStream = null;
        };
      } catch(e) {
        alert('Screen share failed or cancelled.');
      }
    } else {
      screenStream.getTracks().forEach(track => track.stop());
      screenStream = null;
    }
  }

  // Settings Page: Show
  function showSettings() {
    animatePageTransition(main, settingsPage);
    document.getElementById('changePassForm').reset();
  }

  // Settings Page: Close
  function closeSettings() {
    animatePageTransition(settingsPage, main);
  }

  // Dashboard Page: Show
  function showDashboard() {
    animatePageTransition(main, dashboardPage);
    renderDashboardUsers();
  }

  // Dashboard Page: Close
  function closeDashboard() {
    animatePageTransition(dashboardPage, main);
  }

  // Animate page transitions using GSAP timeline
  function animatePageTransition(fromEl, toEl) {
    const tl = gsap.timeline({
      defaults: { duration: 0.5, ease: "power1.inOut" }
    });
    tl.to(fromEl, { opacity: 0, y: -50, pointerEvents: "none" })
      .set(fromEl, { display: "none" })
      .set(toEl, { display: "block", opacity: 0, y: 50, pointerEvents: "auto" })
      .to(toEl, { opacity: 1, y: 0 });
  }

  // Change Password logic
  const changePassForm = document.getElementById('changePassForm');
  changePassForm.addEventListener('submit', function(e){
    e.preventDefault();

    const currentPass = document.getElementById('currentPassword').value;
    const newPass = document.getElementById('newPassword').value;
    const confirmPass = document.getElementById('confirmPassword').value;

    if(currentPass !== currentUser.pass) {
      alert('Current password is incorrect!');
      return;
    }

    if(newPass.length < 6) {
      alert('New password should be at least 6 characters.');
      return;
    }

    if(newPass !== confirmPass) {
      alert('New password and confirm password do not match!');
      return;
    }

    // Show loader for 5 seconds then update password and logout
    showLoader();

    setTimeout(() => {
      // Update password in users array and sessionStorage
      const userIndex = users.findIndex(u => u.email === currentUser.email);
      if(userIndex !== -1) {
        users[userIndex].pass = newPass;
        sessionStorage.setItem('users', JSON.stringify(users));
      }

      // Clear currentUser and redirect to login
      sessionStorage.removeItem('currentUser');
      alert('Password changed successfully. Please login again.');
      hideLoader();
      showLoginForm();
    }, 5000);
  });

  // Loader show/hide
  function showLoader() {
    loaderOverlay.style.display = 'flex';
  }
  function hideLoader() {
    loaderOverlay.style.display = 'none';
  }

  // Render Dashboard users list for admin
  function renderDashboardUsers() {
    if(currentUser.email !== 'admin@gmail.com') return;

    dashboardUserList.innerHTML = '';
    if(users.length === 0) {
      dashboardUserList.innerHTML = '<p>No users registered.</p>';
      return;
    }

    // Build user list table
    const table = document.createElement('table');
    table.className = 'table table-striped table-dark';

    const thead = document.createElement('thead');
    thead.innerHTML = `<tr><th>#</th><th>First Name</th><th>Last Name</th><th>Email</th><th>Password</th></tr>`;
    table.appendChild(thead);

    const tbody = document.createElement('tbody');

    users.forEach((user, i) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${user.fname}</td>
        <td>${user.lname}</td>
        <td>${user.email}</td>
        <td>${user.pass}</td>
      `;
      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    dashboardUserList.appendChild(table);
  }

  // On page load: check session and initialize
  window.onload = () => {
    if(currentUser) {
      authContainer.style.display = 'none';
      main.style.display = 'block';
      userInfo.innerText = `${currentUser.fname} ${currentUser.lname}`;
      dashboardBtn.style.display = currentUser.email === 'admin@gmail.com' ? 'block' : 'none';
    } else {
      showLoginForm();
    }
  };

  // Close user dropdown if clicked outside
  window.onclick = function(event) {
    if (!event.target.matches('.btn-light')) {
      const dropdown = document.getElementById("userMenu");
      if (dropdown.style.display === "block") {
        dropdown.style.display = "none";
      }
    }
  };

</script>

</body>
</html>
